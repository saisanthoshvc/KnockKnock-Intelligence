<!-- templates/review.html -->
{% extends "base.html" %}

{% block title %}Review & Edit - KnockKnock Intelligence{% endblock %}

{% block content %}
<!-- (Your original review.html markup & CSS — unchanged; omitted here for brevity because you pasted it already.) -->
<!-- Paste your full existing HTML/CSS from review.html above this script block. The only change is the JS below. -->

<script>
const BASE = "{{ request.script_root|default('', true) }}";

document.addEventListener('DOMContentLoaded', function() {
    initializeFilters();
    initializeTable();
    updateMetrics();
});

function initializeFilters() {
    const confidenceSlider = document.getElementById('confidenceSlider');
    const confidenceValue = document.getElementById('confidenceValue');
    const typeFilter = document.getElementById('typeFilter');
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');

    confidenceSlider.addEventListener('input', function() {
        const value = this.value;
        confidenceValue.textContent = value + '%';
        filterTable();
    });
    typeFilter.addEventListener('change', filterTable);
    searchInput.addEventListener('input', debounce(filterTable, 300));
    statusFilter.addEventListener('change', filterTable);
}

function initializeTable() {
    document.querySelectorAll('.question-text, .confidence-input, .status-select').forEach(field => {
        field.addEventListener('change', function() {
            const row = this.closest('.question-row');
            row.classList.add('modified');
        });
    });
}

function filterTable() {
    const confidenceThreshold = parseInt(document.getElementById('confidenceSlider').value) / 100;
    const typeFilter = document.getElementById('typeFilter').value;
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;

    const rows = document.querySelectorAll('.question-row');
    rows.forEach(row => {
        const confidence = parseFloat(row.querySelector('.confidence-input').value);
        const type = row.querySelector('.type-badge').textContent.toLowerCase();
        const questionText = row.querySelector('.question-text').value.toLowerCase();
        const status = row.querySelector('.status-select').value;

        let show = true;
        if (confidence < confidenceThreshold) show = false;
        if (typeFilter && type !== typeFilter.toLowerCase()) show = false;
        if (searchTerm && !questionText.includes(searchTerm)) show = false;
        if (statusFilter && status !== statusFilter) show = false;

        row.style.display = show ? '' : 'none';
    });
}

function clearFilters() {
    document.getElementById('confidenceSlider').value = 0;
    document.getElementById('confidenceValue').textContent = '0%';
    document.getElementById('typeFilter').value = '';
    document.getElementById('searchInput').value = '';
    document.getElementById('statusFilter').value = '';
    document.querySelectorAll('.question-row').forEach(row => row.style.display = '');
}

function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    document.querySelectorAll('.row-checkbox').forEach(cb => cb.checked = selectAllCheckbox.checked);
}

function selectAll() {
    document.getElementById('selectAllCheckbox').checked = true;
    toggleSelectAll();
}

function getSelectedRows() {
    const selectedCheckboxes = document.querySelectorAll('.row-checkbox:checked');
    return Array.from(selectedCheckboxes).map(checkbox => checkbox.closest('.question-row'));
}

function saveRow(qid) {
    const row = document.querySelector(`[data-question-id="${qid}"]`);
    const questionData = {
        qid: qid,
        text: row.querySelector('.question-text').value,
        confidence: parseFloat(row.querySelector('.confidence-input').value),
        status: row.querySelector('.status-select').value
    };
    const jobId = window.location.pathname.split('/').pop();

    fetch(`${BASE}/api/save_edits/${jobId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ questions: [questionData] })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) { row.classList.remove('modified'); showNotification('Question saved successfully', 'success'); }
        else { showNotification('Failed to save question', 'error'); }
    })
    .catch(e => { console.error('Save error:', e); showNotification('Error saving question', 'error'); });
}

function saveAllEdits() {
    const modifiedRows = document.querySelectorAll('.question-row.modified');
    if (modifiedRows.length === 0) { showNotification('No changes to save', 'info'); return; }

    const jobId = window.location.pathname.split('/').pop();
    const questions = [];
    modifiedRows.forEach(row => {
        questions.push({
            qid: row.dataset.questionId,
            text: row.querySelector('.question-text').value,
            confidence: parseFloat(row.querySelector('.confidence-input').value),
            status: row.querySelector('.status-select').value
        });
    });

    fetch(`${BASE}/api/save_edits/${jobId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ questions })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            modifiedRows.forEach(row => row.classList.remove('modified'));
            showNotification(`✅ Saved ${questions.length} questions successfully!`, 'success');
        } else {
            showNotification('❌ Failed to save questions', 'error');
        }
    })
    .catch(e => { console.error('Save error:', e); showNotification('❌ Error saving questions: ' + e.message, 'error'); });
}

function deleteRow(qid) {
    if (confirm('Are you sure you want to delete this question?')) {
        document.querySelector(`[data-question-id="${qid}"]`).remove();
        updateMetrics();
        showNotification('Question deleted', 'success');
    }
}

function exportData() { document.getElementById('exportModal').classList.add('show'); }
function closeExportModal() { document.getElementById('exportModal').classList.remove('show'); }

function confirmExport() {
    const format = document.querySelector('input[name="format"]:checked').value;
    const approvedOnly = document.getElementById('exportApproved').checked;
    const highConfidenceOnly = document.getElementById('exportHighConfidence').checked;

    let url = `${BASE}/api/export/{{ job_id }}/${format}`;
    const params = [];
    if (approvedOnly) params.push('approved=true');
    if (highConfidenceOnly) params.push('high_confidence=true');
    if (params.length) url += '?' + params.join('&');

    const link = document.createElement('a');
    link.href = url;
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    closeExportModal();
    showNotification(`Export completed! ${format.toUpperCase()} file downloaded.`, 'success');
}

function updateMetrics() {
    const totalRows = document.querySelectorAll('.question-row').length;
    document.getElementById('totalRows').textContent = totalRows;
    // approved count can be computed if needed
}

function showNotification(message, type) {
    const n = document.createElement('div');
    n.className = `notification ${type}`;
    n.textContent = message;
    document.body.appendChild(n);
    setTimeout(() => { n.classList.add('show'); }, 100);
    setTimeout(() => { n.classList.remove('show'); setTimeout(() => { document.body.removeChild(n); }, 300); }, 3000);
}

function debounce(func, wait) {
    let timeout;
    return function(...args) { clearTimeout(timeout); timeout = setTimeout(() => func(...args), wait); };
}
</script>
{% endblock %}

{% extends "base.html" %}
{% block title %}Review & Edit - KnockKnock Intelligence{% endblock %}

{% block content %}
<div class="review-header">
  <div class="header-content">
    <div class="header-left">
      <h1 class="page-title"><i class="fas fa-edit"></i> Review & Edit Questions</h1>
      <p class="page-subtitle">Review, edit, and export your extracted RFP questions</p>
    </div>
    <div class="header-actions">
      <a href="/" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Back to Upload</a>
    </div>
  </div>
</div>

<div class="card metrics-dashboard">
  <div class="metrics-grid">
    <div class="metric-card"><div class="metric-icon"><i class="fas fa-list"></i></div><div class="metric-content"><div class="metric-value" id="totalRows">{{ questions|length }}</div><div class="metric-label">Total Questions</div></div></div>
    <div class="metric-card"><div class="metric-icon"><i class="fas fa-tags"></i></div><div class="metric-content"><div class="metric-value" id="distinctTypes">{{ questions|map(attribute='type')|unique|list|length }}</div><div class="metric-label">Question Types</div></div></div>
    <div class="metric-card"><div class="metric-icon"><i class="fas fa-chart-line"></i></div><div class="metric-content"><div class="metric-value" id="avgConfidence">{{ "%.1f"|format((questions|map(attribute='confidence')|list|sum / questions|length * 100) if questions else 0) }}%</div><div class="metric-label">Avg Confidence</div></div></div>
    <div class="metric-card"><div class="metric-icon"><i class="fas fa-check-circle"></i></div><div class="metric-content"><div class="metric-value" id="approvedCount">0</div><div class="metric-label">Approved</div></div></div>
  </div>
</div>

<div class="card filters-section">
  <div class="filters-header">
    <h3 class="filters-title"><i class="fas fa-filter"></i> Filters & Controls</h3>
    <div class="filters-actions">
      <button class="btn btn-success" onclick="saveAllEdits()"><i class="fas fa-save"></i> Save All Changes</button>
      <button class="btn btn-secondary" onclick="clearFilters()"><i class="fas fa-times"></i> Clear Filters</button>
      <button class="btn btn-primary" onclick="exportData()"><i class="fas fa-download"></i> Export Results</button>
    </div>
  </div>

  <div class="filters-grid">
    <div class="filter-group">
      <label class="filter-label">Min Confidence</label>
      <div class="confidence-slider">
        <input type="range" id="confidenceSlider" min="0" max="100" value="0" class="slider">
        <div class="slider-value" id="confidenceValue">0%</div>
      </div>
    </div>

    <div class="filter-group">
      <label class="filter-label">Question Type</label>
      <select id="typeFilter" class="filter-select">
        <option value="">All Types</option>
        {% for type in questions|map(attribute='type')|unique|list %}
        <option value="{{ type }}">{{ type|title }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="filter-group">
      <label class="filter-label">Search</label>
      <div class="search-input">
        <i class="fas fa-search"></i>
        <input type="text" id="searchInput" placeholder="Search questions...">
      </div>
    </div>

    <div class="filter-group">
      <label class="filter-label">Status</label>
      <select id="statusFilter" class="filter-select">
        <option value="">All Status</option>
        <option value="approved">Approved</option>
        <option value="pending">Pending</option>
        <option value="rejected">Rejected</option>
      </select>
    </div>
  </div>
</div>

<div class="card questions-section">
  <div class="table-header">
    <h3 class="table-title"><i class="fas fa-table"></i> Questions Table</h3>
    <div class="table-actions">
      <button class="btn btn-secondary" onclick="selectAll()"><i class="fas fa-check-square"></i> Select All</button>
    </div>
  </div>

  <div class="table-container">
    <table class="questions-table" id="questionsTable">
      <thead>
        <tr>
          <th class="checkbox-col"><input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()"></th>
          <th class="question-col">Question</th>
          <th class="confidence-col">Confidence</th>
          <th class="type-col">Type</th>
          <th class="status-col">Status</th>
          <th class="actions-col">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for question in questions %}
        <tr class="question-row" data-question-id="{{ question.qid }}">
          <td class="checkbox-col"><input type="checkbox" class="row-checkbox" value="{{ question.qid }}"></td>
          <td class="question-col">
            <div class="question-content">
              <textarea class="question-text" data-field="text" data-qid="{{ question.qid }}">{{ question.text }}</textarea>
            </div>
          </td>
          <td class="confidence-col">
            <div class="confidence-display">
              <input type="number" class="confidence-input" data-field="confidence" data-qid="{{ question.qid }}" value="{{ question.confidence }}" min="0" max="1" step="0.01">
              <div class="confidence-bar"><div class="confidence-fill" style="width: {{ (question.confidence or 0) * 100 }}%"></div></div>
            </div>
          </td>
          <td class="type-col">
            <span class="type-badge type-{{ question.type }}">{{ question.type }}</span>
          </td>
          <td class="status-col">
            <select class="status-select" data-field="status" data-qid="{{ question.qid }}">
              <option value="pending">Pending</option>
              <option value="approved">Approved</option>
              <option value="rejected">Rejected</option>
            </select>
          </td>
          <td class="actions-col">
            <div class="action-buttons">
              <button class="btn-icon btn-save" onclick="saveRow('{{ question.qid }}')" title="Save"><i class="fas fa-save"></i></button>
              <button class="btn-icon btn-delete" onclick="removeRow('{{ question.qid }}')" title="Delete"><i class="fas fa-trash"></i></button>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="modal" id="exportModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title"><i class="fas fa-download"></i> Export Options</h3>
      <button class="modal-close" onclick="closeExportModal()"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-body">
      <div class="export-options">
        <div class="export-format">
          <h4>Export Format</h4>
          <div class="format-options">
            <label class="format-option"><input type="radio" name="format" value="docx" checked><span class="format-label"><i class="fas fa-file-word"></i> DOCX</span></label>
            <label class="format-option"><input type="radio" name="format" value="xlsx"><span class="format-label"><i class="fas fa-file-excel"></i> Excel</span></label>
          </div>
        </div>
        <div class="export-filters">
          <h4>Export Filters</h4>
          <div class="filter-options">
            <label class="filter-option"><input type="checkbox" id="exportApproved" checked><span>Approved Questions Only</span></label>
            <label class="filter-option"><input type="checkbox" id="exportHighConfidence"><span>High Confidence Only (>80%)</span></label>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeExportModal()">Cancel</button>
      <button class="btn btn-primary" onclick="confirmExport()"><i class="fas fa-download"></i> Export</button>
    </div>
  </div>
</div>

<style>
/* keep your existing review styles (trimmed for brevity) */
.questions-table{width:100%;border-collapse:collapse;font-size:.9rem}
.questions-table th{background:rgba(59,130,246,.1);color:var(--text-primary);font-weight:700;padding:1rem;text-align:left;border-bottom:1px solid var(--border);text-transform:uppercase;letter-spacing:.5px;font-size:.8rem}
.questions-table td{padding:1rem;border-bottom:1px solid rgba(255,255,255,.05);vertical-align:top}
.question-row:hover{background:rgba(59,130,246,.05)}
.question-text{width:100%;min-height:60px;padding:.75rem;background:rgba(255,255,255,.05);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-size:.9rem;resize:vertical}
.confidence-bar{height:4px;background:var(--border);border-radius:2px;overflow:hidden}
.confidence-fill{height:100%;background:linear-gradient(90deg,var(--error),var(--warning),var(--success));transition:width .3s}
.btn-icon{width:32px;height:32px;border:none;border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:.8rem;transition:.3s}
.btn-save{background:rgba(16,185,129,.2);color:var(--success);border:1px solid rgba(16,185,129,.3)}
.btn-delete{background:rgba(239,68,68,.2);color:var(--error);border:1px solid rgba(239,68,68,.3)}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);backdrop-filter:blur(10px);z-index:1000;align-items:center;justify-content:center}
.modal.show{display:flex}
.modal-content{background:var(--glass);backdrop-filter:blur(25px);border:1px solid var(--border);border-radius:20px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto;box-shadow:var(--shadow-2xl)}
</style>

<script>
document.addEventListener('DOMContentLoaded', function(){
  initializeFilters();
  initializeTable();
  updateMetrics();
});

function initializeFilters(){
  const slider=document.getElementById('confidenceSlider');
  const value=document.getElementById('confidenceValue');
  slider.addEventListener('input',()=>{ value.textContent=slider.value+'%'; filterTable(); });
  document.getElementById('typeFilter').addEventListener('change',filterTable);
  document.getElementById('searchInput').addEventListener('input',debounce(filterTable,300));
  document.getElementById('statusFilter').addEventListener('change',filterTable);
}

function initializeTable(){
  document.querySelectorAll('.question-text, .confidence-input, .status-select').forEach(el=>{
    el.addEventListener('change',function(){ this.closest('.question-row').classList.add('modified'); });
  });
}

function filterTable(){
  const threshold=parseInt(document.getElementById('confidenceSlider').value)/100;
  const type=document.getElementById('typeFilter').value.toLowerCase();
  const term=document.getElementById('searchInput').value.toLowerCase();
  const status=document.getElementById('statusFilter').value;
  document.querySelectorAll('.question-row').forEach(row=>{
    const conf=parseFloat(row.querySelector('.confidence-input').value||'0');
    const t=row.querySelector('.type-badge').textContent.toLowerCase();
    const txt=row.querySelector('.question-text').value.toLowerCase();
    const st=row.querySelector('.status-select').value;
    let show=true;
    if(conf<threshold) show=false;
    if(type && t!==type) show=false;
    if(term && !txt.includes(term)) show=false;
    if(status && st!==status) show=false;
    row.style.display=show?'':'none';
  });
}

function clearFilters(){
  document.getElementById('confidenceSlider').value=0;
  document.getElementById('confidenceValue').textContent='0%';
  document.getElementById('typeFilter').value='';
  document.getElementById('searchInput').value='';
  document.getElementById('statusFilter').value='';
  document.querySelectorAll('.question-row').forEach(r=>r.style.display='');
}

function toggleSelectAll(){
  const all=document.getElementById('selectAllCheckbox').checked;
  document.querySelectorAll('.row-checkbox').forEach(cb=>cb.checked=all);
}
function selectAll(){ document.getElementById('selectAllCheckbox').checked=true; toggleSelectAll(); }

function saveRow(qid){
  const row=document.querySelector(`[data-question-id="${qid}"]`);
  const data={ qid, text: row.querySelector('.question-text').value, confidence: parseFloat(row.querySelector('.confidence-input').value||'0'), status: row.querySelector('.status-select').value };
  const jobId = "{{ job_id }}";
  fetch(`/api/save_edits/${jobId}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({questions:[data]})})
    .then(r=>r.json()).then(d=>{ if(d.success){ row.classList.remove('modified'); showNotification('Question saved','success'); } else { showNotification('Save failed','error'); } })
    .catch(()=>showNotification('Save error','error'));
}

function removeRow(qid){
  const row=document.querySelector(`[data-question-id="${qid}"]`);
  row.parentNode.removeChild(row);
  updateMetrics();
  showNotification('Question removed from view','info');
}

function exportData(){ document.getElementById('exportModal').classList.add('show'); }
function closeExportModal(){ document.getElementById('exportModal').classList.remove('show'); }

function confirmExport(){
  const format=document.querySelector('input[name="format"]:checked').value;
  const url=`/api/export/{{ job_id }}/${format}`;
  const a=document.createElement('a'); a.href=url; a.style.display='none'; document.body.appendChild(a); a.click(); document.body.removeChild(a);
  closeExportModal(); showNotification(`Exported ${format.toUpperCase()} file`, 'success');
}

function updateMetrics(){
  const rows=[...document.querySelectorAll('.question-row')];
  const approved = rows.filter(r => r.querySelector('.status-select').value === 'approved').length;
  document.getElementById('totalRows').textContent = rows.length;
  document.getElementById('approvedCount').textContent = approved;
}

function showNotification(message,type){
  const n=document.createElement('div'); n.className=`notification ${type}`; n.textContent=message; document.body.appendChild(n);
  setTimeout(()=>n.classList.add('show'),100); setTimeout(()=>{ n.classList.remove('show'); setTimeout(()=>document.body.removeChild(n),300); },3000);
}

function debounce(fn,wait){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),wait); }; }
</script>
{% endblock %}

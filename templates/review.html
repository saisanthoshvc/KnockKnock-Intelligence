{% extends "base.html" %}

{% block title %}Review & Edit - KnockKnock Intelligence{% endblock %}

{% block content %}
<!-- Header Section -->
<div class="review-header">
    <div class="header-content">
        <div class="header-left">
            <h1 class="page-title">
                <i class="fas fa-edit"></i>
                Review & Edit Questions
            </h1>
            <p class="page-subtitle">Review, edit, and export your extracted RFP questions</p>
        </div>
        <div class="header-actions">
            <a href="{{ url_for('index') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i>
                Back to Upload
            </a>
        </div>
    </div>
</div>

<!-- Metrics Dashboard -->
<div class="card metrics-dashboard">
    <div class="metrics-grid">
        <div class="metric-card">
            <div class="metric-icon">
                <i class="fas fa-list"></i>
            </div>
            <div class="metric-content">
                <div class="metric-value" id="totalRows">{{ questions|length }}</div>
                <div class="metric-label">Total Questions</div>
            </div>
        </div>
        
        <div class="metric-card">
            <div class="metric-icon">
                <i class="fas fa-tags"></i>
            </div>
            <div class="metric-content">
                <div class="metric-value" id="distinctTypes">{{ questions|map(attribute='type')|unique|list|length }}</div>
                <div class="metric-label">Question Types</div>
            </div>
        </div>
        
        <div class="metric-card">
            <div class="metric-icon">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="metric-content">
                <div class="metric-value" id="avgConfidence">{{ "%.1f"|format((questions|map(attribute='confidence')|list|sum / questions|length * 100) if questions else 0) }}%</div>
                <div class="metric-label">Avg Confidence</div>
            </div>
        </div>
        
        <div class="metric-card">
            <div class="metric-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="metric-content">
                <div class="metric-value" id="approvedCount">0</div>
                <div class="metric-label">Approved</div>
            </div>
        </div>
    </div>
</div>

<!-- Filters and Controls -->
<div class="card filters-section">
    <div class="filters-header">
        <h3 class="filters-title">
            <i class="fas fa-filter"></i>
            Filters & Controls
        </h3>
        <div class="filters-actions">
            <button class="btn btn-success" onclick="saveAllEdits()">
                <i class="fas fa-save"></i>
                Save All Changes
            </button>
            <button class="btn btn-secondary" onclick="clearFilters()">
                <i class="fas fa-times"></i>
                Clear Filters
            </button>
            <button class="btn btn-primary" onclick="exportData()">
                <i class="fas fa-download"></i>
                Export Results
            </button>
        </div>
    </div>
    
    <div class="filters-grid">
        <div class="filter-group">
            <label class="filter-label">Min Confidence</label>
            <div class="confidence-slider">
                <input type="range" id="confidenceSlider" min="0" max="100" value="0" class="slider">
                <div class="slider-value" id="confidenceValue">0%</div>
            </div>
        </div>
        
        <div class="filter-group">
            <label class="filter-label">Question Type</label>
            <select id="typeFilter" class="filter-select">
                <option value="">All Types</option>
                {% for type in questions|map(attribute='type')|unique|list %}
                <option value="{{ type }}">{{ type|title }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="filter-group">
            <label class="filter-label">Search</label>
            <div class="search-input">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="Search questions...">
            </div>
        </div>
        
        <div class="filter-group">
            <label class="filter-label">Status</label>
            <select id="statusFilter" class="filter-select">
                <option value="">All Status</option>
                <option value="approved">Approved</option>
                <option value="pending">Pending</option>
                <option value="rejected">Rejected</option>
            </select>
        </div>
    </div>
</div>

<!-- Questions Table -->
<div class="card questions-section">
    <div class="table-header">
        <h3 class="table-title">
            <i class="fas fa-table"></i>
            Questions Table
        </h3>
        <div class="table-actions">
            <button class="btn btn-secondary" onclick="selectAll()">
                <i class="fas fa-check-square"></i>
                Select All
            </button>
            <!-- NEW: Bulk Approve button -->
            <button class="btn btn-success" onclick="bulkApproveAll()">
                <i class="fas fa-check-double"></i>
                Approve All
            </button>
        </div>
    </div>
    
    <div class="table-container">
        <table class="questions-table" id="questionsTable">
            <thead>
                <tr>
                    <th class="checkbox-col">
                        <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                    </th>
                    <th class="question-col">Question</th>
                    <th class="confidence-col">Confidence</th>
                    <th class="type-col">Type</th>
                    <th class="status-col">Status</th>
                    <th class="actions-col">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for question in questions %}
                <tr class="question-row" data-question-id="{{ question.qid }}">
                    <td class="checkbox-col">
                        <input type="checkbox" class="row-checkbox" value="{{ question.qid }}">
                    </td>
                    <td class="question-col">
                        <div class="question-content">
                            <textarea class="question-text" data-field="text" data-qid="{{ question.qid }}">{{ question.text }}</textarea>
                        </div>
                    </td>
                    <td class="confidence-col">
                        <div class="confidence-display">
                            <input type="number" class="confidence-input" data-field="confidence" data-qid="{{ question.qid }}" 
                                   value="{{ question.confidence }}" min="0" max="1" step="0.01">
                            <div class="confidence-bar">
                                <div class="confidence-fill" style="width: {{ question.confidence * 100 }}%"></div>
                            </div>
                        </div>
                    </td>
                    <td class="type-col">
                        <span class="type-badge type-{{ question.type }}">{{ question.type }}</span>
                    </td>
                    <td class="status-col">
                        <select class="status-select" data-field="status" data-qid="{{ question.qid }}">
                            <option value="pending" {{ 'selected' if question.status=='pending' else '' }}>Pending</option>
                            <option value="approved" {{ 'selected' if question.status=='approved' else '' }}>Approved</option>
                            <option value="rejected" {{ 'selected' if question.status=='rejected' else '' }}>Rejected</option>
                        </select>
                    </td>
                    <td class="actions-col">
                        <div class="action-buttons">
                            <button class="btn-icon btn-save" onclick="saveRow('{{ question.qid }}')" title="Save">
                                <i class="fas fa-save"></i>
                            </button>
                            <button class="btn-icon btn-delete" onclick="deleteRow('{{ question.qid }}')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Export Modal (unchanged except IDs already present) -->
<div class="modal" id="exportModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">
                <i class="fas fa-download"></i>
                Export Options
            </h3>
            <button class="modal-close" onclick="closeExportModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="export-options">
                <div class="export-format">
                    <h4>Export Format</h4>
                    <div class="format-options">
                        <label class="format-option">
                            <input type="radio" name="format" value="docx" checked>
                            <span class="format-label">
                                <i class="fas fa-file-word"></i>
                                DOCX
                            </span>
                        </label>
                        <label class="format-option">
                            <input type="radio" name="format" value="xlsx">
                            <span class="format-label">
                                <i class="fas fa-file-excel"></i>
                                Excel
                            </span>
                        </label>
                    </div>
                </div>
                
                <div class="export-filters">
                    <h4>Export Filters</h4>
                    <div class="filter-options">
                        <label class="filter-option">
                            <input type="checkbox" id="exportApproved">
                            <span>Approved Questions Only</span>
                        </label>
                        <label class="filter-option">
                            <input type="checkbox" id="exportHighConfidence">
                            <span>High Confidence Only (>80%)</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeExportModal()">Cancel</button>
            <button class="btn btn-primary" onclick="confirmExport()">
                <i class="fas fa-download"></i>
                Export
            </button>
        </div>
    </div>
</div>

<style>
/* (all your existing styles unchanged) */
.review-header { margin-bottom: 2rem; }
.header-content { display: flex; justify-content: space-between; align-items: flex-start; gap: 2rem; }
.header-left { flex: 1; }
.page-title { font-size: 2.5rem; font-weight: 800; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 1rem; color: var(--text-primary); }
.page-title i { color: var(--accent-blue); font-size: 2rem; }
.page-subtitle { font-size: 1.125rem; color: var(--text-secondary); }
.header-actions { display: flex; gap: 1rem; align-items: center; }

.metrics-dashboard { margin-bottom: 2rem; }
.metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; }
.metric-card { display: flex; align-items: center; gap: 1rem; padding: 1.5rem; background: rgba(255,255,255,0.03); border-radius: 16px; border: 1px solid var(--border); transition: all .3s ease; }
.metric-card:hover { background: rgba(255,255,255,0.05); border-color: var(--border-hover); transform: translateY(-2px); box-shadow: var(--shadow-lg); }
.metric-icon { width: 50px; height: 50px; background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple)); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 1.25rem; box-shadow: var(--shadow); }
.metric-content { flex: 1; }
.metric-value { font-size: 2rem; font-weight: 800; color: var(--text-primary); margin-bottom: .25rem; background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
.metric-label { font-size: .875rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: .5px; }

.filters-section { margin-bottom: 2rem; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 2rem; backdrop-filter: blur(10px); }
.filters-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem; }
.filters-title { font-size: 1.5rem; font-weight: 700; color: var(--text-primary); display: flex; align-items: center; gap: .75rem; }
.filters-title i { color: var(--accent-blue); }
.filters-actions { display: flex; gap: 1rem; }

.filters-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 2rem; align-items: start; }
.filter-group { display: flex; flex-direction: column; gap: .5rem; }
.filter-label { font-weight: 600; color: var(--text-primary); font-size: .9rem; text-transform: uppercase; letter-spacing: .5px; }
.confidence-slider { display: flex; align-items: center; gap: 1rem; }
.slider { flex: 1; height: 6px; border-radius: 3px; background: var(--border); outline: none; -webkit-appearance: none; }
.slider::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; border-radius: 50%; background: var(--accent-blue); cursor: pointer; box-shadow: var(--shadow); }
.slider-value { font-weight: 700; color: var(--accent-blue); min-width: 40px; text-align: center; }
.filter-select { padding: .75rem 1rem; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 12px; color: var(--text-primary); font-size: .9rem; transition: all .3s ease; }
.filter-select:focus { outline: none; border-color: var(--accent-blue); box-shadow: 0 0 0 3px rgba(59,130,246,.1); }
.search-input { position: relative; display: flex; align-items: center; }
.search-input i { position: absolute; left: 1rem; color: var(--text-muted); z-index: 1; }
.search-input input { width: 100%; padding: .75rem 1rem .75rem 2.5rem; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 12px; color: var(--text-primary); font-size: .9rem; transition: all .3s ease; }
.search-input input:focus { outline: none; border-color: var(--accent-blue); box-shadow: 0 0 0 3px rgba(59,130,246,.1); }

.questions-section { margin-bottom: 2rem; }
.table-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
.table-title { font-size: 1.5rem; font-weight: 700; color: var(--text-primary); display: flex; align-items: center; gap: .75rem; }
.table-title i { color: var(--accent-blue); }
.table-actions { display: flex; gap: .75rem; }
.table-container { overflow-x: auto; border-radius: 16px; border: 1px solid var(--border); background: rgba(255,255,255,0.02); }
.questions-table { width: 100%; border-collapse: collapse; font-size: .9rem; }
.questions-table th { background: rgba(59,130,246,.1); color: var(--text-primary); font-weight: 700; padding: 1rem; text-align: left; border-bottom: 1px solid var(--border); text-transform: uppercase; letter-spacing: .5px; font-size: .8rem; }
.questions-table td { padding: 1rem; border-bottom: 1px solid rgba(255,255,255,.05); vertical-align: top; }
.question-row:hover { background: rgba(59,130,246,.05); }
.checkbox-col { width: 50px; text-align: center; }
.question-col { min-width: 300px; }
.question-text { width: 100%; min-height: 60px; padding: .75rem; background: rgba(255,255,255,.05); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: .9rem; line-height: 1.4; resize: vertical; transition: all .3s ease; }
.question-text:focus { outline: none; border-color: var(--accent-blue); box-shadow: 0 0 0 2px rgba(59,130,246,.1); }
.confidence-col { width: 150px; }
.confidence-display { display: flex; flex-direction: column; gap: .5rem; }
.confidence-input { width: 100%; padding: .5rem; background: rgba(255,255,255,.05); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-size: .8rem; text-align: center; }
.confidence-bar { height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; }
.confidence-fill { height: 100%; background: linear-gradient(90deg, var(--error), var(--warning), var(--success)); transition: width .3s ease; }
.type-col { width: 120px; }
.type-badge { display: inline-block; padding: .25rem .75rem; border-radius: 12px; font-size: .75rem; font-weight: 600; text-transform: uppercase; letter-spacing: .5px; }
.type-what { background: rgba(59,130,246,.2); color: var(--accent-blue); }
.type-how { background: rgba(16,185,129,.2); color: var(--success); }
.type-when { background: rgba(245,158,11,.2); color: var(--warning); }
.type-where { background: rgba(139,92,246,.2); color: var(--accent-purple); }
.type-why { background: rgba(239,68,68,.2); color: var(--error); }
.type-other { background: rgba(107,114,128,.2); color: var(--text-muted); }
.status-col { width: 120px; }
.status-select { width: 100%; padding: .5rem; background: rgba(255,255,255,.05); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-size: .8rem; }
.actions-col { width: 100px; }
.action-buttons { display: flex; gap: .5rem; }
.btn-icon { width: 32px; height: 32px; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: .8rem; transition: all .3s ease; }
.btn-save { background: rgba(16,185,129,.2); color: var(--success); border: 1px solid rgba(16,185,129,.3); }
.btn-save:hover { background: var(--success); color: #fff; transform: scale(1.1); }
.btn-delete { background: rgba(239,68,68,.2); color: var(--error); border: 1px solid rgba(239,68,68,.3); }
.btn-delete:hover { background: var(--error); color: #fff; transform: scale(1.1); }

/* Modal + Responsive + Notifications unchanged */
.modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,.8); backdrop-filter: blur(10px); z-index: 1000; align-items: center; justify-content: center; }
.modal.show { display: flex; }
.modal-content { background: var(--glass); backdrop-filter: blur(25px); border: 1px solid var(--border); border-radius: 20px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: var(--shadow-2xl); }
.modal-header { display: flex; justify-content: space-between; align-items: center; padding: 1.5rem; border-bottom: 1px solid var(--border); }
.modal-title { font-size: 1.25rem; font-weight: 700; color: var(--text-primary); display: flex; align-items: center; gap: .75rem; }
.modal-title i { color: var(--accent-blue); }
.modal-close { width: 32px; height: 32px; border: none; background: rgba(255,255,255,.1); border-radius: 6px; color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all .3s ease; }
.modal-close:hover { background: var(--error); color: #fff; }
.modal-body { padding: 1.5rem; }
.modal-footer { display: flex; justify-content: flex-end; gap: 1rem; padding: 1.5rem; border-top: 1px solid var(--border); }
.export-options { display: flex; flex-direction: column; gap: 2rem; }
.export-format h4, .export-filters h4 { font-size: 1rem; font-weight: 700; color: var(--text-primary); margin-bottom: 1rem; }
.format-options { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
.format-option { display: flex; align-items: center; gap: .75rem; padding: 1rem; background: rgba(255,255,255,.03); border: 1px solid var(--border); border-radius: 12px; cursor: pointer; transition: all .3s ease; }
.format-option:hover { background: rgba(255,255,255,.05); border-color: var(--border-hover); }
.format-option input[type="radio"] { margin: 0; }
.format-label { display: flex; align-items: center; gap: .5rem; font-weight: 600; color: var(--text-primary); }
.format-label i { color: var(--accent-blue); }
.filter-options { display: flex; flex-direction: column; gap: 1rem; }
.filter-option { display: flex; align-items: center; gap: .75rem; padding: .75rem; background: rgba(255,255,255,.03); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; transition: all .3s ease; }
.filter-option:hover { background: rgba(255,255,255,.05); border-color: var(--border-hover); }
.filter-option input[type="checkbox"] { margin: 0; }

@media (max-width: 1024px) {
    .header-content { flex-direction: column; align-items: stretch; }
    .header-actions { justify-content: flex-end; }
    .metrics-grid { grid-template-columns: repeat(2, 1fr); }
    .filters-grid { grid-template-columns: 1fr; }
}
@media (max-width: 768px) {
    .page-title { font-size: 2rem; }
    .metrics-grid { grid-template-columns: 1fr; }
    .table-actions { flex-direction: column; gap: .5rem; }
    .questions-table { font-size: .8rem; }
    .questions-table th, .questions-table td { padding: .75rem .5rem; }
    .format-options { grid-template-columns: 1fr; }
}
@media (max-width: 480px) {
    .header-actions { flex-direction: column; gap: .75rem; }
    .filters-actions { flex-direction: column; gap: .75rem; }
    .table-actions { flex-direction: column; gap: .5rem; }
}

.notification { position: fixed; top: 20px; right: 20px; padding: 1rem 1.5rem; border-radius: 12px; color: #fff; font-weight: 600; z-index: 10000; transform: translateX(100%); transition: transform .3s ease; max-width: 400px; box-shadow: 0 10px 25px rgba(0,0,0,.3); }
.notification.show { transform: translateX(0); }
.notification.success { background: linear-gradient(135deg, #10b981, #059669); }
.notification.error { background: linear-gradient(135deg, #ef4444, #dc2626); }
.notification.info { background: linear-gradient(135deg, #3b82f6, #2563eb); }
</style>

<script>
// Make job-specific URLs so we don’t string-replace everywhere
const JOB_ID = "{{ job_id }}";
const URLS = {
    saveEdits: "{{ url_for('save_edits', job_id=job_id) }}",
    exportDocx: "{{ url_for('export_data', job_id=job_id, format='docx') }}",
    exportXlsx: "{{ url_for('export_data', job_id=job_id, format='xlsx') }}"
};

document.addEventListener('DOMContentLoaded', function() {
    initializeFilters();
    initializeTable();
    updateMetrics();
});

function initializeFilters() {
    const confidenceSlider = document.getElementById('confidenceSlider');
    const confidenceValue = document.getElementById('confidenceValue');
    const typeFilter = document.getElementById('typeFilter');
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    
    confidenceSlider.addEventListener('input', function() {
        const value = this.value;
        confidenceValue.textContent = value + '%';
        filterTable();
    });
    typeFilter.addEventListener('change', filterTable);
    searchInput.addEventListener('input', debounce(filterTable, 300));
    statusFilter.addEventListener('change', filterTable);
}

function initializeTable() {
    document.querySelectorAll('.question-text, .confidence-input, .status-select').forEach(field => {
        field.addEventListener('change', function() {
            const row = this.closest('.question-row');
            row.classList.add('modified');
            if (this.classList.contains('status-select')) {
                updateMetrics();
            }
        });
    });
}

function filterTable() {
    const confidenceThreshold = parseInt(document.getElementById('confidenceSlider').value) / 100;
    const typeFilter = document.getElementById('typeFilter').value;
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    
    const rows = document.querySelectorAll('.question-row');
    rows.forEach(row => {
        const confidence = parseFloat(row.querySelector('.confidence-input').value);
        const type = row.querySelector('.type-badge').textContent.toLowerCase();
        const questionText = row.querySelector('.question-text').value.toLowerCase();
        const status = row.querySelector('.status-select').value;
        
        let show = true;
        if (confidence < confidenceThreshold) show = false;
        if (typeFilter && type !== typeFilter.toLowerCase()) show = false;
        if (searchTerm && !questionText.includes(searchTerm)) show = false;
        if (statusFilter && status !== statusFilter) show = false;
        row.style.display = show ? '' : 'none';
    });
}

function clearFilters() {
    document.getElementById('confidenceSlider').value = 0;
    document.getElementById('confidenceValue').textContent = '0%';
    document.getElementById('typeFilter').value = '';
    document.getElementById('searchInput').value = '';
    document.getElementById('statusFilter').value = '';
    document.querySelectorAll('.question-row').forEach(row => { row.style.display = ''; });
}

function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    const rowCheckboxes = document.querySelectorAll('.row-checkbox');
    rowCheckboxes.forEach(checkbox => { checkbox.checked = selectAllCheckbox.checked; });
}

function selectAll() {
    document.getElementById('selectAllCheckbox').checked = true;
    toggleSelectAll();
}

function getSelectedRows() {
    const selectedCheckboxes = document.querySelectorAll('.row-checkbox:checked');
    return Array.from(selectedCheckboxes).map(checkbox => checkbox.closest('.question-row'));
}

function saveRow(qid) {
    const row = document.querySelector(`[data-question-id="${qid}"]`);
    const questionData = {
        qid: qid,
        text: row.querySelector('.question-text').value,
        confidence: parseFloat(row.querySelector('.confidence-input').value),
        status: row.querySelector('.status-select').value
    };
    fetch(URLS.saveEdits, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ questions: [questionData] })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            row.classList.remove('modified');
            showNotification('Question saved successfully', 'success');
        } else {
            showNotification('Failed to save question', 'error');
        }
    })
    .catch(err => {
        console.error('Save error:', err);
        showNotification('Error saving question', 'error');
    });
}

function saveAllEdits() {
    const modifiedRows = document.querySelectorAll('.question-row.modified');
    if (modifiedRows.length === 0) {
        showNotification('No changes to save', 'info');
        return;
    }
    const questions = [];
    modifiedRows.forEach(row => {
        const questionData = {
            qid: row.dataset.questionId,
            text: row.querySelector('.question-text').value,
            confidence: parseFloat(row.querySelector('.confidence-input').value),
            status: row.querySelector('.status-select').value
        };
        questions.push(questionData);
    });
    fetch(URLS.saveEdits, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ questions })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            modifiedRows.forEach(row => row.classList.remove('modified'));
            showNotification(`✅ Saved ${questions.length} questions successfully!`, 'success');
        } else {
            showNotification('❌ Failed to save questions', 'error');
        }
    })
    .catch(err => {
        console.error('Save error:', err);
        showNotification('❌ Error saving questions: ' + err.message, 'error');
    });
}

function deleteRow(qid) {
    if (confirm('Are you sure you want to delete this question?')) {
        const row = document.querySelector(`[data-question-id="${qid}"]`);
        if (row) row.remove();
        updateMetrics();
        showNotification('Question deleted locally. Save to persist changes.', 'info');
    }
}

function exportData() {
    document.getElementById('exportModal').classList.add('show');
}

function closeExportModal() {
    document.getElementById('exportModal').classList.remove('show');
}

function confirmExport() {
    const format = document.querySelector('input[name="format"]:checked').value;
    const approvedOnly = document.getElementById('exportApproved').checked;
    const highConfidenceOnly = document.getElementById('exportHighConfidence').checked;

    if (approvedOnly) {
        const approvedNow = Array.from(document.querySelectorAll('.status-select'))
            .filter(sel => sel.value === 'approved').length;
        if (approvedNow === 0) {
            const proceed = confirm('No questions are marked Approved. Export will be empty. Continue?');
            if (!proceed) return;
        }
    }

    let url = (format === 'docx') ? URLS.exportDocx : URLS.exportXlsx;

    const qs = new URLSearchParams();
    if (approvedOnly) qs.set('approved', 'true');
    if (highConfidenceOnly) qs.set('high_confidence', 'true');
    if ([...qs].length) url += `?${qs.toString()}`;

    const link = document.createElement('a');
    link.href = url;
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    closeExportModal();
    showNotification(`Export completed! ${format.toUpperCase()} file downloaded.`, 'success');
}

function updateMetrics() {
    const totalRows = document.querySelectorAll('.question-row').length;
    const approvedCount = Array.from(document.querySelectorAll('.status-select'))
        .filter(sel => sel.value === 'approved').length;
    document.getElementById('totalRows').textContent = totalRows;
    document.getElementById('approvedCount').textContent = approvedCount;
}

/* NEW: Bulk Approve All */
function bulkApproveAll() {
    const rows = document.querySelectorAll('.question-row');
    if (rows.length === 0) {
        showNotification('No questions to approve', 'info');
        return;
    }
    const ok = confirm(`Approve ALL ${rows.length} questions? This will mark every question as Approved and save.`);
    if (!ok) return;

    rows.forEach(row => {
        const statusSel = row.querySelector('.status-select');
        if (statusSel && statusSel.value !== 'approved') {
            statusSel.value = 'approved';
            row.classList.add('modified');
        }
    });

    updateMetrics();
    // Persist immediately so export reflects approvals
    saveAllEdits();
}

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    document.body.appendChild(notification);
    setTimeout(() => { notification.classList.add('show'); }, 100);
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => { document.body.removeChild(notification); }, 300);
    }, 3000);
}

function debounce(func, wait) {
    let timeout;
    return function(...args) {
        const later = () => { clearTimeout(timeout); func(...args); };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}
</script>
{% endblock %}

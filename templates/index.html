{% extends "base.html" %}
{% block title %}KnockKnock Intelligence - AI-Powered RFP Extraction{% endblock %}

{% block content %}
<div class="hero-section">
  <div class="hero-content">
    <h1 class="hero-title">
      <span class="hero-title-line">AI-Powered</span>
      <span class="hero-title-line gradient-text">RFP Extraction</span>
    </h1>
    <p class="hero-subtitle">
      Transform your RFP documents into actionable insights with cutting-edge AI technology.
      Extract, analyze, and process questions with unprecedented accuracy and speed.
    </p>
    <div class="hero-stats">
      <div class="stat-item"><div class="stat-number" id="documentsProcessed">{{ stats.documents_processed }}</div><div class="stat-label">Documents Processed</div></div>
      <div class="stat-item"><div class="stat-number" id="questionsExtracted">{{ stats.questions_extracted }}</div><div class="stat-label">Questions Extracted</div></div>
      <div class="stat-item"><div class="stat-number" id="accuracyRate">{{ stats.accuracy_rate }}%</div><div class="stat-label">Accuracy Rate</div></div>
      <div class="stat-item"><div class="stat-number" id="avgProcessingTime">{{ stats.avg_processing_time }}s</div><div class="stat-label">Avg Processing Time</div></div>
    </div>
  </div>
</div>

<div class="card upload-section">
  <div class="section-header">
    <h2 class="section-title"><i class="fas fa-upload"></i> Upload & Extract</h2>
    <p class="section-subtitle">Upload your RFP document and let our AI extract questions automatically</p>
  </div>

  <div class="upload-container">
    <div class="upload-area" id="uploadSection">
      <div class="upload-content">
        <div class="upload-icon"><i class="fas fa-cloud-upload-alt"></i></div>
        <h3 class="upload-title">Drop your file here</h3>
        <p class="upload-subtitle">or click to browse</p>
        <div class="upload-formats">
          <span class="format-tag">DOCX</span><span class="format-tag">PDF</span><span class="format-tag">XLSX</span>
        </div>
        <input type="file" id="fileInput" accept=".docx,.pdf,.xlsx" style="display:none">
      </div>
    </div>

    <div class="upload-options">
      <div class="option-group">
        <h4 class="option-title"><i class="fas fa-brain"></i> AI Classification</h4>
        <p class="option-description">Use AI to categorize questions automatically</p>
        <label class="radio-option"><input type="radio" name="processingMode" value="ai" id="useLLM" checked><span class="radio-custom"></span></label>
      </div>
      <div class="option-group">
        <h4 class="option-title"><i class="fas fa-sync"></i> Sync Mode</h4>
        <p class="option-description">Faster processing for small documents</p>
        <label class="radio-option"><input type="radio" name="processingMode" value="sync" id="useSync"><span class="radio-custom"></span></label>
      </div>
    </div>

    <div class="upload-actions">
      <button class="btn btn-primary btn-large" id="extractBtn" onclick="parseDocument()"><i class="fas fa-magic"></i> Extract Questions</button>
    </div>
  </div>

  <div class="processing-status" id="processingStatus" style="display:none">
    <div class="status-content">
      <div class="status-icon"><div class="loading"></div></div>
      <div class="status-text">
        <h4 class="status-title">Processing Document</h4>
        <p class="status-message" id="statusMessage">Analyzing document structure...</p>
      </div>
    </div>
    <div class="progress-container">
      <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
      <div class="progress-text"><span id="progressText">0%</span><span id="elapsedTime">Elapsed: 0s</span></div>
    </div>
  </div>
</div>

<style>
/* keep your original styles (truncated here for brevity) */
.hero-section{text-align:center;padding:4rem 0;margin-bottom:3rem}
.hero-content{max-width:1000px;margin:0 auto}
.hero-title{font-size:4rem;font-weight:900;margin-bottom:1.5rem;line-height:1.1}
.hero-title-line{display:block}
.gradient-text{background:linear-gradient(135deg,var(--accent-blue),var(--accent-purple),var(--accent-teal));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.hero-subtitle{font-size:1.25rem;color:var(--text-secondary);margin-bottom:3rem;max-width:600px;margin-left:auto;margin-right:auto}
.hero-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:2rem;margin-top:3rem}
.stat-item{text-align:center;padding:1.5rem;background:rgba(255,255,255,.05);border-radius:16px;border:1px solid var(--border);backdrop-filter:blur(10px)}
.stat-number{font-size:2.5rem;font-weight:800;color:var(--accent-blue);margin-bottom:.5rem;background:linear-gradient(135deg,var(--accent-blue),var(--accent-purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.upload-section{margin-bottom:3rem}
.section-header{text-align:center;margin-bottom:3rem}
.section-title{font-size:2.5rem;font-weight:800;margin-bottom:1rem;display:flex;align-items:center;justify-content:center;gap:1rem;color:var(--text-primary)}
.section-title i{color:var(--accent-blue);font-size:2rem}
.section-subtitle{font-size:1.125rem;color:var(--text-secondary);max-width:500px;margin:0 auto}
.upload-container{max-width:800px;margin:0 auto}
.upload-area{border:3px dashed var(--border);border-radius:20px;padding:4rem 2rem;text-align:center;cursor:pointer;transition:.4s;background:rgba(255,255,255,.02);margin-bottom:2rem}
.upload-area:hover{border-color:var(--accent-blue);background:rgba(59,130,246,.05)}
.processing-status{margin-top:2rem;padding:2rem;background:rgba(59,130,246,.05);border:1px solid rgba(59,130,246,.2);border-radius:16px;backdrop-filter:blur(10px)}
.progress-text{display:flex;justify-content:space-between;margin-top:.5rem;font-size:.875rem;color:var(--text-secondary)}
.btn-large{padding:1.25rem 3rem;font-size:1.125rem;font-weight:700}
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const uploadArea = document.getElementById('uploadSection');
  const fileInput = document.getElementById('fileInput');
  const extractBtn = document.getElementById('extractBtn');
  const processingStatus = document.getElementById('processingStatus');
  const statusMessage = document.getElementById('statusMessage');
  const progressFill = document.getElementById('progressFill');
  const progressText = document.getElementById('progressText');
  const elapsedTime = document.getElementById('elapsedTime');

  let selectedFile = null;
  let startTime = null;
  let progressTimer = null;
  let pollTimer = null;

  uploadArea.addEventListener('click', () => fileInput.click());
  uploadArea.addEventListener('dragover', e => { e.preventDefault(); uploadArea.classList.add('dragover'); });
  uploadArea.addEventListener('dragleave', e => { e.preventDefault(); uploadArea.classList.remove('dragover'); });
  uploadArea.addEventListener('drop', e => { e.preventDefault(); uploadArea.classList.remove('dragover'); if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]); });
  fileInput.addEventListener('change', e => { if (e.target.files.length) handleFile(e.target.files[0]); });

  function handleFile(file){
    selectedFile = file;
    uploadArea.innerHTML = `
      <div class="upload-content">
        <div class="upload-icon"><i class="fas fa-check-circle"></i></div>
        <h3 class="upload-title">File Selected</h3>
        <p class="upload-subtitle">${file.name}</p>
        <div class="upload-formats"><span class="format-tag">Ready to Process</span></div>
      </div>`;
    extractBtn.disabled = false;
  }

  window.parseDocument = function(){
    if(!selectedFile){ alert('Please select a file first'); return; }
    const mode = document.querySelector('input[name="processingMode"]:checked').value;
    const formData = new FormData();
    formData.append('file', selectedFile);
    formData.append('use_llm', mode === 'ai');
    formData.append('use_sync', mode === 'sync');
    formData.append('mode', 'balanced');

    processingStatus.style.display = 'block';
    extractBtn.disabled = true;
    startTime = Date.now();
    progressTimer = setInterval(updateElapsed, 1000);

    fetch('/api/upload', { method:'POST', body: formData })
      .then(async (res) => {
        const data = await res.json().catch(() => ({}));
        if(!res.ok || data.error){ throw new Error(data.error || `Upload failed (${res.status})`); }
        if(data.async){
          startPolling(data.job_id);
        } else {
          window.location.href = `/review/${data.job_id}`;
        }
      })
      .catch(err => {
        clearTimers();
        alert('Upload failed: ' + err.message);
        processingStatus.style.display = 'none';
        extractBtn.disabled = false;
      });
  };

  function startPolling(jobId){
    // progress ticker (cosmetic)
    pollTimer = setInterval(async () => {
      try{
        const res = await fetch(`/api/poll/${jobId}`);
        const data = await res.json();
        if(!res.ok || data.error){
          throw new Error(data.error || `Polling failed (${res.status})`);
        }
        updateStatus(data);
        if(data.status === 'completed'){
          clearTimers();
          window.location.href = `/review/${jobId}`;
        } else if (data.status === 'failed'){
          clearTimers();
          alert('Processing failed: ' + (data.error || 'Unknown error'));
          processingStatus.style.display = 'none';
          extractBtn.disabled = false;
        }
      } catch(err){
        clearTimers();
        alert('Polling error: ' + err.message);
        processingStatus.style.display = 'none';
        extractBtn.disabled = false;
      }
    }, 2000);
  }

  function updateStatus(data){
    if(data.progress && data.progress.message){ statusMessage.textContent = data.progress.message; }
    let pct = 0;
    if(data.status === 'processing') pct = 50;
    if(data.status === 'completed') pct = 100;
    progressFill.style.width = pct + '%';
    progressText.textContent = pct + '%';
  }

  function updateElapsed(){
    const s = Math.floor((Date.now() - startTime)/1000);
    elapsedTime.textContent = `Elapsed: ${s}s`;
  }

  function clearTimers(){ if(progressTimer){ clearInterval(progressTimer); progressTimer=null; } if(pollTimer){ clearInterval(pollTimer); pollTimer=null; } }

  // live stats refresh
  setInterval(() => {
    fetch('/').then(r => r.text()).then(html => {
      const d = new DOMParser().parseFromString(html,'text/html');
      ['documentsProcessed','questionsExtracted','accuracyRate','avgProcessingTime'].forEach(id => {
        const el = d.getElementById(id); if(el) document.getElementById(id).textContent = el.textContent;
      });
    }).catch(()=>{});
  }, 30000);
});
</script>
{% endblock %}

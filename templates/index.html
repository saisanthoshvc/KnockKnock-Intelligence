{% extends "base.html" %}

{% block title %}KnockKnock Intelligence - AI-Powered RFP Extraction{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="hero-section">
    <div class="hero-content">
        <h1 class="hero-title">
            <span class="hero-title-line">AI-Powered</span>
            <span class="hero-title-line gradient-text">RFP Extraction</span>
        </h1>
        <p class="hero-subtitle">
            Transform your RFP documents into actionable insights with cutting-edge AI technology. 
            Extract, analyze, and process questions with unprecedented accuracy and speed.
        </p>
        <div class="hero-stats">
            <div class="stat-item">
                <div class="stat-number" id="documentsProcessed">{{ stats.documents_processed }}</div>
                <div class="stat-label">Documents Processed</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="questionsExtracted">{{ stats.questions_extracted }}</div>
                <div class="stat-label">Questions Extracted</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="accuracyRate">{{ stats.accuracy_rate }}%</div>
                <div class="stat-label">Accuracy Rate</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="avgProcessingTime">{{ stats.avg_processing_time }}s</div>
                <div class="stat-label">Avg Processing Time</div>
            </div>
        </div>
    </div>
</div>

<!-- Upload Section -->
<div class="card upload-section">
    <div class="section-header">
        <h2 class="section-title">
            <i class="fas fa-upload"></i>
            Upload & Extract
        </h2>
        <p class="section-subtitle">Upload your RFP document and let our AI extract questions automatically</p>
    </div>

    <div class="upload-container">
        <div class="upload-area" id="uploadSection">
            <div class="upload-content">
                <div class="upload-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <h3 class="upload-title">Drop your file here</h3>
                <p class="upload-subtitle">or click to browse</p>
                <div class="upload-formats">
                    <span class="format-tag">DOCX</span>
                    <span class="format-tag">PDF</span>
                    <span class="format-tag">XLSX</span>
                </div>
                <input type="file" id="fileInput" accept=".docx,.pdf,.xlsx" style="display: none;">
            </div>
        </div>

        <div class="upload-options">
            <div class="option-group">
                <h4 class="option-title">
                    <i class="fas fa-brain"></i>
                    AI Classification
                </h4>
                <p class="option-description">Use AI to categorize questions automatically</p>
                <label class="radio-option">
                    <input type="radio" name="processingMode" value="ai" id="useLLM" checked>
                    <span class="radio-custom"></span>
                </label>
            </div>

            <div class="option-group">
                <h4 class="option-title">
                    <i class="fas fa-sync"></i>
                    Sync Mode
                </h4>
                <p class="option-description">Faster processing for small documents</p>
                <label class="radio-option">
                    <input type="radio" name="processingMode" value="sync" id="useSync">
                    <span class="radio-custom"></span>
                </label>
            </div>
        </div>

        <div class="upload-actions">
            <button class="btn btn-primary btn-large" id="extractBtn" onclick="parseDocument()">
                <i class="fas fa-magic"></i>
                Extract Questions
            </button>
        </div>
    </div>

    <!-- Processing Status -->
    <div class="processing-status" id="processingStatus" style="display: none;">
        <div class="status-content">
            <div class="status-icon">
                <div class="loading"></div>
            </div>
            <div class="status-text">
                <h4 class="status-title">Processing Document</h4>
                <p class="status-message" id="statusMessage">Analyzing document structure...</p>
            </div>
        </div>
        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
            <div class="progress-text">
                <span id="progressText">0%</span>
                <span id="elapsedTime">Elapsed: 0s</span>
            </div>
        </div>
    </div>
</div>

<!-- Technology Section (unchanged styles/markup) -->
<div class="card technology-section">
    <div class="section-header">
        <h2 class="section-title">
            <i class="fas fa-cogs"></i>
            Advanced Technology
        </h2>
        <p class="section-subtitle">Powered by cutting-edge AI and machine learning</p>
    </div>

    <div class="tech-grid">
        <div class="tech-item">
            <div class="tech-icon">
                <i class="fas fa-robot"></i>
            </div>
            <h4 class="tech-title">AI Classification</h4>
            <p class="tech-description">Advanced machine learning models for question categorization</p>
        </div>

        <div class="tech-item">
            <div class="tech-icon">
                <i class="fas fa-search"></i>
            </div>
            <h4 class="tech-title">Smart Extraction</h4>
            <p class="tech-description">Intelligent pattern recognition for accurate question detection</p>
        </div>

        <div class="tech-item">
            <div class="tech-icon">
                <i class="fas fa-shield-alt"></i>
            </div>
            <h4 class="tech-title">Secure Processing</h4>
            <p class="tech-description">Enterprise-grade security for your sensitive documents</p>
        </div>

        <div class="tech-item">
            <div class="tech-icon">
                <i class="fas fa-bolt"></i>
            </div>
            <h4 class="tech-title">Lightning Fast</h4>
            <p class="tech-description">Optimized processing for maximum speed and efficiency</p>
        </div>
    </div>
</div>

<style>
/* (Your original styles from index.html can remain unchanged; omitted here for brevity) */
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const uploadArea = document.getElementById('uploadSection');
    const fileInput = document.getElementById('fileInput');
    const extractBtn = document.getElementById('extractBtn');
    const processingStatus = document.getElementById('processingStatus');
    const statusMessage = document.getElementById('statusMessage');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const elapsedTime = document.getElementById('elapsedTime');

    let selectedFile = null;
    let startTime = null;
    let progressInterval = null;

    uploadArea.addEventListener('click', () => fileInput.click());
    uploadArea.addEventListener('dragover', handleDragOver);
    uploadArea.addEventListener('dragleave', handleDragLeave);
    uploadArea.addEventListener('drop', handleDrop);
    fileInput.addEventListener('change', handleFileSelect);

    function handleDragOver(e) { e.preventDefault(); uploadArea.classList.add('dragover'); }
    function handleDragLeave(e) { e.preventDefault(); uploadArea.classList.remove('dragover'); }
    function handleDrop(e) { e.preventDefault(); uploadArea.classList.remove('dragover'); const files = e.dataTransfer.files; if (files.length > 0) handleFile(files[0]); }
    function handleFileSelect(e) { const files = e.target.files; if (files.length > 0) handleFile(files[0]); }

    function handleFile(file) {
        selectedFile = file;
        uploadArea.innerHTML = `
            <div class="upload-content">
                <div class="upload-icon"><i class="fas fa-check-circle"></i></div>
                <h3 class="upload-title">File Selected</h3>
                <p class="upload-subtitle">${file.name}</p>
                <div class="upload-formats"><span class="format-tag">Ready to Process</span></div>
            </div>`;
        extractBtn.disabled = false;
    }

    window.parseDocument = function() {
        if (!selectedFile) { alert('Please select a file first'); return; }

        const processingMode = document.querySelector('input[name="processingMode"]:checked').value;
        const useLLM = processingMode === 'ai';
        const useSync = processingMode === 'sync';

        const formData = new FormData();
        formData.append('file', selectedFile);
        formData.append('use_llm', useLLM ? 'true' : 'false');
        formData.append('use_sync', useSync ? 'true' : 'false');
        formData.append('mode', 'balanced');

        processingStatus.style.display = 'block';
        extractBtn.disabled = true;
        startTime = Date.now();
        updateElapsedTime();

        fetch(window.URLS.upload, { method: 'POST', body: formData })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.async) {
                    startPolling(data.job_id);
                } else {
                    const reviewUrl = window.URLS.review.replace('__JOB__', data.job_id);
                    window.location.href = reviewUrl;
                }
            } else {
                throw new Error(data.error || 'Upload failed');
            }
        })
        .catch(error => {
            console.error('Upload error:', error);
            alert('Upload failed: ' + error.message);
            processingStatus.style.display = 'none';
            extractBtn.disabled = false;
        });
    };

    function startPolling(jobId) {
        const pollUrl = window.URLS.poll.replace('__JOB__', jobId);
        const pollInterval = setInterval(() => {
            fetch(pollUrl)
            .then(response => response.json())
            .then(data => {
                updateStatus(data);
                if (data.status === 'completed') {
                    clearInterval(pollInterval);
                    if (progressInterval) clearInterval(progressInterval);
                    const reviewUrl = window.URLS.review.replace('__JOB__', jobId);
                    window.location.href = reviewUrl;
                } else if (data.status === 'failed') {
                    clearInterval(pollInterval);
                    if (progressInterval) clearInterval(progressInterval);
                    alert('Processing failed: ' + (data.error || 'Unknown error'));
                    processingStatus.style.display = 'none';
                    extractBtn.disabled = false;
                }
            })
            .catch(error => {
                console.error('Polling error:', error);
                clearInterval(pollInterval);
                if (progressInterval) clearInterval(progressInterval);
                alert('Polling failed: ' + error.message);
                processingStatus.style.display = 'none';
                extractBtn.disabled = false;
            });
        }, 2000);

        progressInterval = setInterval(() => { updateElapsedTime(); }, 1000);
    }

    function updateStatus(data) {
        if (data.progress && data.progress.message) {
            statusMessage.textContent = data.progress.message;
        }
        let progress = 0;
        if (data.status === 'processing') progress = 50;
        else if (data.status === 'completed') progress = 100;
        progressFill.style.width = progress + '%';
        progressText.textContent = progress + '%';
    }

    function updateElapsedTime() {
        if (startTime) {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            elapsedTime.textContent = `Elapsed: ${elapsed}s`;
        }
    }

    function refreshStats() {
        fetch(window.URLS.index)
        .then(response => response.text())
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const newStats = {
                documentsProcessed: doc.getElementById('documentsProcessed')?.textContent || '0',
                questionsExtracted: doc.getElementById('questionsExtracted')?.textContent || '0',
                accuracyRate: doc.getElementById('accuracyRate')?.textContent || '0%',
                avgProcessingTime: doc.getElementById('avgProcessingTime')?.textContent || '0s'
            };
            document.getElementById('documentsProcessed').textContent = newStats.documentsProcessed;
            document.getElementById('questionsExtracted').textContent = newStats.questionsExtracted;
            document.getElementById('accuracyRate').textContent = newStats.accuracyRate;
            document.getElementById('avgProcessingTime').textContent = newStats.avgProcessingTime;
        })
        .catch(error => console.error('Error refreshing stats:', error));
    }
    setInterval(refreshStats, 30000);
});
</script>
{% endblock %}

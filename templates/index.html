{% extends "base.html" %}

{% block title %}KnockKnock Intelligence - AI-Powered RFP Extraction{% endblock %}

{# ---- SAFE DEFAULTS FOR STATS ---- #}
{% set s = stats|default({
  'documents_processed': 0,
  'questions_extracted': 0,
  'accuracy_rate': 0,
  'avg_processing_time': 0
}) %}

{% block content %}
<!-- Hero Section -->
<div class="hero-section">
    <div class="hero-content">
        <h1 class="hero-title">
            <span class="hero-title-line">AI-Powered</span>
            <span class="hero-title-line gradient-text">RFP Extraction</span>
        </h1>
        <p class="hero-subtitle">
            Transform your RFP documents into actionable insights with cutting-edge AI technology. 
            Extract, analyze, and process questions with unprecedented accuracy and speed.
        </p>
        <div class="hero-stats">
            <div class="stat-item">
                <div class="stat-number" id="documentsProcessed">{{ s.documents_processed }}</div>
                <div class="stat-label">Documents Processed</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="questionsExtracted">{{ s.questions_extracted }}</div>
                <div class="stat-label">Questions Extracted</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="accuracyRate">{{ s.accuracy_rate }}%</div>
                <div class="stat-label">Accuracy Rate</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="avgProcessingTime">{{ s.avg_processing_time }}s</div>
                <div class="stat-label">Avg Processing Time</div>
            </div>
        </div>
    </div>
</div>

<!-- Upload Section -->
<div class="card upload-section">
    <div class="section-header">
        <h2 class="section-title">
            <i class="fas fa-upload"></i>
            Upload & Extract
        </h2>
        <p class="section-subtitle">Upload your RFP document and let our AI extract questions automatically</p>
    </div>

    <div class="upload-container">
        <div class="upload-area" id="uploadSection" role="button" tabindex="0" aria-label="Upload file">
            <div class="upload-content">
                <div class="upload-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <h3 class="upload-title">Drop your file here</h3>
                <p class="upload-subtitle">or click to browse</p>
                <div class="upload-formats">
                    <span class="format-tag">DOCX</span>
                    <span class="format-tag">PDF</span>
                    <span class="format-tag">XLSX</span>
                </div>
                <!-- NOTE: no pattern= here; only accept=. Server validates type. -->
                <input type="file" id="fileInput" accept=".docx,.pdf,.xlsx" style="display:none" />
            </div>
        </div>

        <div class="upload-options">
            <div class="option-group">
                <h4 class="option-title">
                    <i class="fas fa-brain"></i>
                    AI Classification
                </h4>
                <p class="option-description">Use AI to categorize questions automatically</p>
                <label class="radio-option">
                    <input type="radio" name="processingMode" value="ai" id="useLLM" checked>
                    <span class="radio-custom"></span>
                </label>
            </div>

            <div class="option-group">
                <h4 class="option-title">
                    <i class="fas fa-sync"></i>
                    Sync Mode
                </h4>
                <p class="option-description">Faster processing for small documents</p>
                <label class="radio-option">
                    <input type="radio" name="processingMode" value="sync" id="useSync">
                    <span class="radio-custom"></span>
                </label>
            </div>
        </div>

        <div class="upload-actions">
            <button class="btn btn-primary btn-large" id="extractBtn" onclick="parseDocument()" disabled>
                <i class="fas fa-magic"></i>
                Extract Questions
            </button>
        </div>
    </div>

    <!-- Processing Status -->
    <div class="processing-status" id="processingStatus" style="display: none;">
        <div class="status-content">
            <div class="status-icon">
                <div class="loading"></div>
            </div>
            <div class="status-text">
                <h4 class="status-title">Processing Document</h4>
                <p class="status-message" id="statusMessage">Analyzing document structure...</p>
            </div>
        </div>
        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
            <div class="progress-text">
                <span id="progressText">0%</span>
                <span id="elapsedTime">Elapsed: 0s</span>
            </div>
        </div>
    </div>
</div>

<!-- Technology Section -->
<div class="card technology-section">
    <div class="section-header">
        <h2 class="section-title">
            <i class="fas fa-cogs"></i>
            Advanced Technology
        </h2>
        <p class="section-subtitle">Powered by cutting-edge AI and machine learning</p>
    </div>

    <div class="tech-grid">
        <div class="tech-item">
            <div class="tech-icon"><i class="fas fa-robot"></i></div>
            <h4 class="tech-title">AI Classification</h4>
            <p class="tech-description">Advanced machine learning models for question categorization</p>
        </div>

        <div class="tech-item">
            <div class="tech-icon"><i class="fas fa-search"></i></div>
            <h4 class="tech-title">Smart Extraction</h4>
            <p class="tech-description">Intelligent pattern recognition for accurate question detection</p>
        </div>

        <div class="tech-item">
            <div class="tech-icon"><i class="fas fa-shield-alt"></i></div>
            <h4 class="tech-title">Secure Processing</h4>
            <p class="tech-description">Enterprise-grade security for your sensitive documents</p>
        </div>

        <div class="tech-item">
            <div class="tech-icon"><i class="fas fa-bolt"></i></div>
            <h4 class="tech-title">Lightning Fast</h4>
            <p class="tech-description">Optimized processing for maximum speed and efficiency</p>
        </div>
    </div>
</div>

<style>
/* (styles unchanged, trimmed for brevity; you can keep your full block) */

/* ensure button disabled style looks clickable only when enabled */
#extractBtn:disabled { opacity: .5; cursor: not-allowed; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const uploadArea = document.getElementById('uploadSection');
  const fileInput = document.getElementById('fileInput');
  const extractBtn = document.getElementById('extractBtn');
  const processingStatus = document.getElementById('processingStatus');
  const statusMessage = document.getElementById('statusMessage');
  const progressFill = document.getElementById('progressFill');
  const progressText = document.getElementById('progressText');
  const elapsedTime = document.getElementById('elapsedTime');

  let selectedFile = null;
  let startTime = null;
  let progressInterval = null;

  // File upload handling
  uploadArea.addEventListener('click', () => fileInput.click());
  uploadArea.addEventListener('dragover', handleDragOver);
  uploadArea.addEventListener('dragleave', handleDragLeave);
  uploadArea.addEventListener('drop', handleDrop);
  fileInput.addEventListener('change', handleFileSelect);

  function handleDragOver(e) {
    e.preventDefault();
    uploadArea.classList.add('dragover');
  }
  function handleDragLeave(e) {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
  }
  function handleDrop(e) {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    if (e.dataTransfer.files?.length) handleFile(e.dataTransfer.files[0]);
  }
  function handleFileSelect(e) {
    if (e.target.files?.length) handleFile(e.target.files[0]);
  }

  function handleFile(file) {
    // permissive client-side check (no HTML pattern!)
    const name = (file.name || '').toLowerCase();
    const ok = name.endsWith('.docx') || name.endsWith('.pdf') || name.endsWith('.xlsx');
    if (!ok) {
      alert('Please select a DOCX, PDF, or XLSX file.');
      return;
    }

    selectedFile = file;

    // Rebuild inner content safely to show selection
    uploadArea.innerHTML = '';
    const wrap = document.createElement('div');
    wrap.className = 'upload-content';
    wrap.innerHTML = `
      <div class="upload-icon"><i class="fas fa-check-circle"></i></div>
      <h3 class="upload-title">File Selected</h3>
      <p class="upload-subtitle" id="selName"></p>
      <div class="upload-formats"><span class="format-tag">Ready to Process</span></div>
    `;
    uploadArea.appendChild(wrap);
    wrap.querySelector('#selName').textContent = file.name;

    extractBtn.disabled = false;
  }

  // Parse document
  window.parseDocument = function() {
    if (!selectedFile) { alert('Please select a file first'); return; }

    const mode = document.querySelector('input[name="processingMode"]:checked')?.value || 'ai';
    const useLLM = (mode === 'ai');
    const useSync = (mode === 'sync');

    const formData = new FormData();
    formData.append('file', selectedFile);
    formData.append('use_llm', String(useLLM));
    formData.append('use_sync', String(useSync));
    formData.append('mode', 'balanced');

    processingStatus.style.display = 'block';
    extractBtn.disabled = true;
    startTime = Date.now();
    if (progressInterval) clearInterval(progressInterval);
    progressInterval = setInterval(updateElapsedTime, 1000);

    fetch('/api/upload', { method: 'POST', body: formData })
      .then(async (res) => {
        const contentType = res.headers.get('content-type') || '';
        let payload;
        try {
          payload = contentType.includes('application/json') ? await res.json() : { success: false, error: await res.text() };
        } catch (_) {
          payload = { success: false, error: 'Unexpected response from server.' };
        }
        if (!res.ok) {
          throw new Error(payload.error || `HTTP ${res.status}`);
        }
        return payload;
      })
      .then((data) => {
        console.log('Upload response:', data);
        if (data.success) {
          if (data.async) {
            startPolling(data.job_id);
          } else {
            window.location.href = `/review/${data.job_id}`;
          }
        } else {
          throw new Error(data.error || 'Upload failed');
        }
      })
      .catch((err) => {
        console.error('Upload error:', err);
        alert('Upload failed: ' + err.message);
        processingStatus.style.display = 'none';
        extractBtn.disabled = false;
        if (progressInterval) clearInterval(progressInterval);
      });
  };

  function startPolling(jobId) {
    const poller = setInterval(() => {
      fetch(`/api/poll/${jobId}`)
        .then(r => r.json())
        .then(data => {
          console.log('Poll response:', data);
          updateStatus(data);
          if (data.status === 'completed') {
            clearInterval(poller);
            if (progressInterval) clearInterval(progressInterval);
            window.location.href = `/review/${jobId}`;
          } else if (data.status === 'failed') {
            clearInterval(poller);
            if (progressInterval) clearInterval(progressInterval);
            alert('Processing failed: ' + (data.error || 'Unknown error'));
            processingStatus.style.display = 'none';
            extractBtn.disabled = false;
          }
        })
        .catch(err => {
          console.error('Polling error:', err);
          clearInterval(poller);
          if (progressInterval) clearInterval(progressInterval);
          alert('Polling failed: ' + err.message);
          processingStatus.style.display = 'none';
          extractBtn.disabled = false;
        });
    }, 2000);
  }

  function updateStatus(data) {
    if (data.progress?.message) statusMessage.textContent = data.progress.message;
    let pct = 0;
    if (data.status === 'processing') pct = 50;
    if (data.status === 'completed') pct = 100;
    progressFill.style.width = pct + '%';
    progressText.textContent = pct + '%';
  }

  function updateElapsedTime() {
    if (!startTime) return;
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    elapsedTime.textContent = `Elapsed: ${elapsed}s`;
  }

  // Periodic stat refresh (non-breaking even if index renders with defaults)
  setInterval(() => {
    fetch('/').then(r => r.text()).then(html => {
      const doc = new DOMParser().parseFromString(html, 'text/html');
      const get = id => doc.getElementById(id)?.textContent || null;
      const updates = {
        documentsProcessed: get('documentsProcessed'),
        questionsExtracted: get('questionsExtracted'),
        accuracyRate: get('accuracyRate'),
        avgProcessingTime: get('avgProcessingTime')
      };
      if (updates.documentsProcessed) document.getElementById('documentsProcessed').textContent = updates.documentsProcessed;
      if (updates.questionsExtracted) document.getElementById('questionsExtracted').textContent = updates.questionsExtracted;
      if (updates.accuracyRate) document.getElementById('accuracyRate').textContent = updates.accuracyRate;
      if (updates.avgProcessingTime) document.getElementById('avgProcessingTime').textContent = updates.avgProcessingTime;
    }).catch(() => {});
  }, 30000);
});
</script>
{% endblock %}
